---

kind: pipeline
type: docker
name: deploy

steps:
  - name: deploy
    image: haxorof/ansible:v5-ubuntu
    user: root
    environment:
      VAULT_PASS:
        from_secret: "vault_pass"
      SSH_KEY:
        from_secret: "ssh_key"
    commands:
      - echo $${VAULT_PASS} > .vault_pass.txt
      - eval $(ssh-agent)
      - echo $${SSH_KEY} | ssh-add -
      - ansible-galaxy install -r requirements.yml
      - ansible-playbook --tags deploy-wh-api,deploy-questionnaire-bot --user droneci --inventory inventory/prod.yml playbooks/prod.yml
